name: Auto Build function (manual + call)

on:
  workflow_call:
    inputs:
      arch:
        type: string
      gapps:
        type: string
      root:
        type: string
      release_type:
        type: string

  workflow_dispatch:
    inputs:
      arch:
        description: "Ch·ªçn ki·∫øn tr√∫c (x64/arm64)"
        required: true
        default: "x64"
        type: choice
        options:
          - x64
          - arm64
      gapps:
        description: "Lo·∫°i GApps"
        required: true
        default: "MindTheGapps"
        type: choice
        options:
          - None
          - MindTheGapps
      root:
        description: "Root Solution (none/magisk)"
        required: true
        default: "none"
        type: choice
        options:
          - none
          - magisk
      release_type:
        description: "Ki·ªÉu ph√°t h√†nh"
        required: true
        default: "WIF"
        type: choice
        options:
          - WIF
          - Retail

jobs:
  build:
    name: Build WSA
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ‚ôªÔ∏è
        uses: actions/checkout@v4

      - name: Setup Python üè≠
        uses: actions/setup-python@v5
        with:
          check-latest: true
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: scripts/

      - name: Setup Python3 Virtual Enviroment üêç
        working-directory: scripts
        run: |
          sudo apt-get update
          PYTHON_VENV_DIR="$(dirname "$PWD")/python3-env"
          python3 -m venv "$PYTHON_VENV_DIR" || abort "Failed to create python3 virtual env"
          source "$PYTHON_VENV_DIR/bin/activate" || abort "Failed to activate python3 virtual env"
          python3 -c "import pkg_resources; pkg_resources.require(open('requirements.txt',mode='r'))" &>/dev/null || {
              echo "Installing Python3 dependencies"
              python3 -m pip install --upgrade -r requirements.txt || abort "Failed to install python3 dependencies"
          }
          deactivate

      - name: Install Ubuntu Dependencies üßë‚Äçüè≠
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: e2fsprogs attr unzip qemu-utils python3-venv
          version: 1.0

     - name: Build WSA
    run: |
      ARCH="${{ github.event.inputs.arch }}"
      ROOT="${{ github.event.inputs.root }}"

      # N·∫øu kh√¥ng c√≥ input th√¨ d√πng m·∫∑c ƒë·ªãnh
      if [ -z "$ARCH" ]; then
        ARCH="x64"
      fi
      if [ -z "$ROOT" ]; then
        ROOT="false"
      fi

      echo ">>> Building WSA for $ARCH with GApps (Root=$ROOT)"
      # G·ªçi script build ch√≠nh
      ./scripts/build.sh --arch "$ARCH" --gapps --root "$ROOT"


