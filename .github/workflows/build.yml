name: Build WSA

on:
  workflow_dispatch:
    inputs:
      arch:
        description: "Architecture (x64 hoặc arm64)"
        required: false
        default: "x64"
      root:
        description: "Root (true/false)"
        required: false
        default: "false"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Python3 Virtual Environment
        working-directory: scripts
        run: |
          sudo apt-get update
          PYTHON_VENV_DIR="$(dirname "$PWD")/python3-env"
          python3 -m venv "$PYTHON_VENV_DIR" || abort "Failed to create python3 virtual env"
          source "$PYTHON_VENV_DIR/bin/activate" || abort "Failed to activate python3 virtual env"
          python3 -c "import pkg_resources; pkg_resources.require(open('requirements.txt',mode='r'))" >/dev/null 2>&1 || {
            echo "Installing Python3 dependencies"
            python3 -m pip install --upgrade -r requirements.txt || abort "Failed to install python3 dependencies"
          }
          deactivate

      - name: Install Ubuntu Dependencies
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: e2fsprogs attr unzip qemu-utils python3-venv
          version: 1.0

      - name: Build WSA
        run: |
          ARCH="${{ github.event.inputs.arch }}"
          ROOT="${{ github.event.inputs.root }}"

          # Nếu ARCH trống thì gán mặc định x64
          if [ -z "$ARCH" ]; then
            ARCH="x64"
          fi

          # Nếu ROOT trống thì gán mặc định false
          if [ -z "$ROOT" ]; then
            ROOT="false"
          fi

          echo ">>> Building WSA for $ARCH with GApps (Root=$ROOT)"
          ./scripts/build.sh --arch "$ARCH" --gapps --root "$ROOT"

